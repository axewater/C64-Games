#include "room.h"
#include "screen.h"
#include <conio.h>
#include <string.h>

static Room current_room;
static uint8_t exits_locked;

/* Predefined room layouts */

/* Room 0: Starting room - Simple center box */
static const uint8_t room0_layout[ROOM_HEIGHT][ROOM_WIDTH] = {
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32}
};

/* Room 1: Wide corridor maze with 3-4 char passages */
static const uint8_t room1_layout[ROOM_HEIGHT][ROOM_WIDTH] = {
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32},
    {32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32},
    {32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32},
    {32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32},
    {32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32}
};

/* Room 2: Four corners */
static const uint8_t room2_layout[ROOM_HEIGHT][ROOM_WIDTH] = {
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,160,160,160,160,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32}
};

/* Room 3: Plus sign */
static const uint8_t room3_layout[ROOM_HEIGHT][ROOM_WIDTH] = {
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160},
    {160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,32,32,32,32,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,160,160,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32}
};

/* Room 4: Diagonal corridors */
static const uint8_t room4_layout[ROOM_HEIGHT][ROOM_WIDTH] = {
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32},
    {32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32},
    {32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32},
    {32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32},
    {32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32},
    {32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,160,32,32,32,32,160,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32},
    {32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32}
};

void room_init(void) {
    exits_locked = 1;
    room_load(0);
}

void room_load(uint8_t room_id) {
    current_room.id = room_id;

    /* Select room layout */
    switch (room_id) {
        case 0:
            current_room.layout = (const uint8_t*)room0_layout;
            current_room.exits = EXIT_SOUTH;
            break;
        case 1:
            current_room.layout = (const uint8_t*)room1_layout;
            current_room.exits = EXIT_NORTH | EXIT_SOUTH;
            break;
        case 2:
            current_room.layout = (const uint8_t*)room2_layout;
            current_room.exits = EXIT_NORTH | EXIT_SOUTH;
            break;
        case 3:
            current_room.layout = (const uint8_t*)room3_layout;
            current_room.exits = EXIT_NORTH | EXIT_EAST | EXIT_WEST | EXIT_SOUTH;
            break;
        case 4:
            current_room.layout = (const uint8_t*)room4_layout;
            current_room.exits = EXIT_NORTH;
            break;
        default:
            current_room.layout = (const uint8_t*)room0_layout;
            current_room.exits = EXIT_SOUTH;
            break;
    }
}

void room_render(void) {
    uint8_t x, y;
    uint8_t ch, color;

    /* Render room layout (skip row 0, it's for HUD) */
    for (y = 0; y < ROOM_HEIGHT; y++) {
        for (x = 0; x < ROOM_WIDTH; x++) {
            ch = current_room.layout[y * ROOM_WIDTH + x];

            /* Set color based on character type */
            if (ch == WALL_CHAR) {
                color = COLOR_BLUE;
            } else {
                color = COLOR_BLACK;
            }

            screen_set_char(x, y + 1, ch, color);
        }
    }

    /* Draw exit indicators */
    if (current_room.exits & EXIT_NORTH) {
        ch = exits_locked ? EXIT_CLOSED_CHAR : EXIT_OPEN_CHAR;
        color = exits_locked ? COLOR_RED : COLOR_GREEN;
        screen_set_char(18, 1, ch, color);
        screen_set_char(19, 1, ch, color);
        screen_set_char(20, 1, ch, color);
        screen_set_char(21, 1, ch, color);
    }

    if (current_room.exits & EXIT_SOUTH) {
        ch = exits_locked ? EXIT_CLOSED_CHAR : EXIT_OPEN_CHAR;
        color = exits_locked ? COLOR_RED : COLOR_GREEN;
        screen_set_char(18, 24, ch, color);
        screen_set_char(19, 24, ch, color);
        screen_set_char(20, 24, ch, color);
        screen_set_char(21, 24, ch, color);
    }

    if (current_room.exits & EXIT_EAST) {
        ch = exits_locked ? EXIT_CLOSED_CHAR : EXIT_OPEN_CHAR;
        color = exits_locked ? COLOR_RED : COLOR_GREEN;
        screen_set_char(39, 11, ch, color);
        screen_set_char(39, 12, ch, color);
        screen_set_char(39, 13, ch, color);
    }

    if (current_room.exits & EXIT_WEST) {
        ch = exits_locked ? EXIT_CLOSED_CHAR : EXIT_OPEN_CHAR;
        color = exits_locked ? COLOR_RED : COLOR_GREEN;
        screen_set_char(0, 11, ch, color);
        screen_set_char(0, 12, ch, color);
        screen_set_char(0, 13, ch, color);
    }
}

uint8_t room_check_collision(uint16_t x, uint16_t y) {
    uint8_t char_x, char_y;
    uint8_t ch;

    /* Convert pixel coordinates to character coordinates */
    /* Sprite coordinates: x: 24-320, y: 50-229 */
    /* Character grid: x: 0-39, y: 0-23 (in room layout, 1-24 on screen) */
    if (x < 24 || x > 320 || y < 50 || y > 229) {
        return 0;
    }

    char_x = (x - 24) / 8;
    char_y = (y - 50) / 8;

    if (char_x >= ROOM_WIDTH || char_y >= ROOM_HEIGHT) {
        return 0;
    }

    ch = current_room.layout[char_y * ROOM_WIDTH + char_x];

    /* Check if it's a wall */
    return (ch == WALL_CHAR) ? 1 : 0;
}

uint8_t room_check_exit(uint16_t x, uint16_t y) {
    uint8_t char_x, char_y;

    /* Don't check exits if they're locked */
    if (exits_locked) {
        return EXIT_NONE;
    }

    /* Convert pixel coordinates to character coordinates */
    if (x < 24 || x > 320 || y < 50 || y > 229) {
        return EXIT_NONE;
    }

    char_x = (x - 24) / 8;
    char_y = (y - 50) / 8;

    /* Check North exit (top rows - more forgiving) */
    if ((current_room.exits & EXIT_NORTH) && char_y <= 1 && char_x >= 17 && char_x <= 22) {
        return EXIT_NORTH;
    }

    /* Check South exit (bottom rows - more forgiving) */
    if ((current_room.exits & EXIT_SOUTH) && char_y >= 22 && char_x >= 17 && char_x <= 22) {
        return EXIT_SOUTH;
    }

    /* Check East exit (right edge - more forgiving) */
    if ((current_room.exits & EXIT_EAST) && char_x >= 38 && char_y >= 10 && char_y <= 14) {
        return EXIT_EAST;
    }

    /* Check West exit (left edge - more forgiving) */
    if ((current_room.exits & EXIT_WEST) && char_x <= 1 && char_y >= 10 && char_y <= 14) {
        return EXIT_WEST;
    }

    return EXIT_NONE;
}

void room_set_exits_locked(uint8_t locked) {
    exits_locked = locked;
}

uint8_t room_get_current(void) {
    return current_room.id;
}
